<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistente Virtual</title>
<style>
body { font-family: Arial, sans-serif; margin:0; }
#chatIcon {
    position: fixed; bottom: 20px; right: 20px;
    width: 60px; height: 60px; border-radius: 50%;
    background: #007bff; color: white; font-size: 30px;
    border: none; cursor: pointer; z-index: 1000;
}
#chatContainer {
    display: none; position: fixed; bottom: 90px; right: 20px;
    width: 350px; max-height: 500px; background: white;
    border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    flex-direction: column; overflow: hidden; z-index: 999;
}
#chatBox { flex:1; padding:15px; overflow-y:auto; max-height:400px; }
.message { margin:10px 0; padding:10px; border-radius:8px; white-space: pre-line; }
.bot { background:#e1f0ff; align-self:flex-start; }
.user { background:#d1ffd1; align-self:flex-end; }
#userInput { display:flex; border-top:1px solid #ccc; }
#inputField { flex:1; padding:10px; border:none; }
#sendBtn { padding:10px 20px; background:#007bff; color:white; border:none; cursor:pointer; }
#sendBtn:hover { background:#0056b3; }
.opcionBtn {
    margin:5px 0; padding:8px 10px; background:#007bff;
    color:white; border:none; border-radius:6px; cursor:pointer; width:100%; text-align:left;
}
.opcionBtn:hover { background:#0056b3; }
</style>
</head>
<body>

<button id="chatIcon">ðŸ’¬</button>

<div id="chatContainer" style="display:flex; flex-direction:column;">
    <div id="chatBox"></div>
    <div id="userInput">
        <input type="text" id="inputField" placeholder="EscribÃ­ tu mensaje...">
        <button id="sendBtn">Enviar</button>
    </div>
</div>

<script>
function normalizar(texto){
    return texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}

// Ãrbol completo con reinicio automÃ¡tico, sin volver al inicio tras derivar a operador
const chatTree = {
    "Inicio": {mensaje:"Â¡Hola! Bienvenido al soporte. Â¿CÃ³mo podemos ayudarte hoy?", opciones:[
        {texto:"Problemas con el sistema", nodo:"Problemas_sistema", numero:"1"},
        {texto:"Consultas sobre servicios", nodo:"Consultas_servicios", numero:"2"},
        {texto:"Promociones", nodo:"Promociones", numero:"3"},
        {texto:"Con un operador", nodo:"Operador", numero:"4"}
    ]},
    "Problemas_sistema": {mensaje:"Vamos a intentar solucionar el problema con el sistema. Â¿Se carga la pÃ¡gina correctamente?", opciones:[
        {texto:"SÃ­", nodo:"Problemas_sistema_si", numero:"1"},
        {texto:"No", nodo:"Verificar_conexion", numero:"2"}
    ]},
    "Problemas_sistema_si": {mensaje:"Me indicas en quÃ© mÃ¡s te puedo ayudar", opciones:[]},
    "Verificar_conexion": {mensaje:"Por favor, verifica que estÃ©s conectado a internet. Â¿FuncionÃ³?", opciones:[
        {texto:"SÃ­", nodo:"Problemas_sistema_si", numero:"1"},
        {texto:"No", nodo:"Probar_otro_navegador", numero:"2"}
    ]},
    "Probar_otro_navegador": {mensaje:"Intenta abrir el sistema en otro navegador. Â¿FuncionÃ³?", opciones:[
        {texto:"SÃ­", nodo:"Problemas_sistema_si", numero:"1"},
        {texto:"No", nodo:"Derivar_operador", numero:"2"}
    ]},
    "Derivar_operador": {mensaje:"Te voy a derivar a un operador. Por favor, espera un momento.", opciones:[], reinicio:true},
    "Consultas_servicios": {mensaje:"Â¿QuÃ© consulta deseas realizar?", opciones:[
        {texto:"Realizar bÃºsqueda de un servicio", nodo:"Busqueda_servicio", numero:"1"},
        {texto:"Procesar pago", nodo:"Procesar_pago", numero:"2"},
        {texto:"Servicios disponibles por rubro", nodo:"Servicios_rubro", numero:"3"}
    ]},
    "Busqueda_servicio": {mensaje:"Verifica el buscador e ingresa el nombre del servicio que deseas abonar. Â¿Lograste encontrar el servicio?", opciones:[
        {texto:"SÃ­", nodo:"Consulta_servicio_si", numero:"1"},
        {texto:"No", nodo:"Derivar_operador", numero:"2"}
    ]},
    "Consulta_servicio_si": {mensaje:"Me indicas en quÃ© mÃ¡s te puedo ayudar", opciones:[]},
    "Procesar_pago": {mensaje:"Al momento de completar los campos, presionÃ¡ el botÃ³n de procesar pago. Â¿Lograste realizar el pago?", opciones:[
        {texto:"SÃ­", nodo:"Consulta_servicio_si", numero:"1"},
        {texto:"No", nodo:"Derivar_operador", numero:"2"}
    ]},
    "Servicios_rubro": {mensaje:"Estos son los servicios disponibles para tu local comercial. Â¿Lograste verificar el servicio que deseas abonar?", opciones:[
        {texto:"SÃ­", nodo:"Consulta_servicio_si", numero:"1"},
        {texto:"No", nodo:"Derivar_operador", numero:"2"}
    ]},
    "Promociones": {mensaje:"Selecciona el tipo de promociÃ³n que deseas consultar:", opciones:[
        {texto:"Promociones vigentes", nodo:"Promociones_vigentes", numero:"1"},
        {texto:"CÃ³mo participar en promociones", nodo:"Participar_promociones", numero:"2"}
    ]},
    "Promociones_vigentes": {mensaje:"Actualmente tenemos las siguientes promociones activas. Â¿TenÃ©s alguna duda o consulta mÃ¡s referente a las promociones?", opciones:[
        {texto:"SÃ­", nodo:"Consulta_servicio_si", numero:"1"},
        {texto:"No", nodo:"Encuesta_final", numero:"2"}
    ]},
    "Participar_promociones": {mensaje:"Para participar, sigue estos pasos. Â¿TenÃ©s alguna duda o consulta mÃ¡s referente a las promociones?", opciones:[
        {texto:"SÃ­", nodo:"Consulta_servicio_si", numero:"1"},
        {texto:"No", nodo:"Encuesta_final", numero:"2"}
    ]},
    "Operador": {mensaje:"Te voy a derivar a un operador. Por favor, espera un momento.", opciones:[], reinicio:true},
    "Encuesta_final": {mensaje:"Por favor, califica tu experiencia del 1 al 5, donde 1 es muy insatisfecho y 5 muy satisfecho.", opciones:[
        {texto:"1", nodo:null, numero:"1"},
        {texto:"2", nodo:null, numero:"2"},
        {texto:"3", nodo:null, numero:"3"},
        {texto:"4", nodo:null, numero:"4"},
        {texto:"5", nodo:null, numero:"5"}
    ], reinicio:true}
};

const sinonimos={
    "Problemas_sistema":["sistema","problema","error","fallo","issue","1"],
    "Consultas_servicios":["servicio","pago","consulta","2"],
    "Promociones":["promocion","oferta","premio","sorteo","3"],
    "Operador":["operador","agente","humano","4"]
};

let nodoActual="Inicio";
const chatBox=document.getElementById("chatBox");
const inputField=document.getElementById("inputField");
const sendBtn=document.getElementById("sendBtn");
const chatIcon=document.getElementById("chatIcon");
const chatContainer=document.getElementById("chatContainer");

function mostrarMensaje(texto,clase="bot"){
    const div=document.createElement("div");
    div.className=`message ${clase}`;
    div.textContent=texto;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function mostrarOpciones(opciones){
    opciones.forEach(opcion=>{
        const btn=document.createElement("button");
        btn.textContent=opcion.numero+") "+opcion.texto;
        btn.className="opcionBtn";
        btn.onclick=()=>avanzarNodo(opcion.nodo);
        chatBox.appendChild(btn);
    });
}

function avanzarNodo(nodo){
    if(!nodo){ reiniciarChat(); return; }
    nodoActual=nodo;
    mostrarMensaje(chatTree[nodo].mensaje,"bot");
    document.querySelectorAll(".opcionBtn").forEach(b=>b.remove());
    if(chatTree[nodo].opciones) mostrarOpciones(chatTree[nodo].opciones);
    if(chatTree[nodo].reinicio) setTimeout(reiniciarChat,2500);
}

function reiniciarChat(){
    nodoActual="Inicio";
    chatBox.innerHTML="";
    mostrarMensaje(chatTree[nodoActual].mensaje,"bot");
    mostrarOpciones(chatTree[nodoActual].opciones);
}

function procesarMensaje(texto){
    mostrarMensaje(texto,"user");
    texto=normalizar(texto);
    let encontrado=false;

    for(let nodo in sinonimos){
        for(let palabra of sinonimos[nodo]){
            if(texto.includes(palabra)){
                avanzarNodo(nodo);
                encontrado=true; break;
            }
        }
        if(encontrado) break;
    }

    if(!encontrado){
        const opciones = chatTree[nodoActual].opciones || [];
        for(let opcion of opciones){
            if(texto===opcion.numero){
                avanzarNodo(opcion.nodo);
                encontrado=true; break;
            }
        }
    }

    if(!encontrado){
        mostrarMensaje("No entendÃ­ tu respuesta. SeleccionÃ¡ un botÃ³n o escribÃ­ una palabra clave.","bot");
    }
}

mostrarMensaje(chatTree[nodoActual].mensaje);
mostrarOpciones(chatTree[nodoActual].opciones);

sendBtn.addEventListener("click",()=>{if(inputField.value.trim()!==""){procesarMensaje(inputField.value); inputField.value="";}});
inputField.addEventListener("keypress",(e)=>{if(e.key==="Enter" && inputField.value.trim()!==""){procesarMensaje(inputField.value); inputField.value="";}});
chatIcon.addEventListener("click",()=>{chatContainer.style.display=chatContainer.style.display==="flex"?"none":"flex";});
</script>

</body>
</html>

